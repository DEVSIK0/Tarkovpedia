# ---- Build ----
FROM node:20-alpine AS build
WORKDIR /app

# Instala deps con caché
COPY package*.json ./
RUN npm ci

# Copia el código y build de Nuxt (genera .output)
COPY . .
RUN npm run build

# ---- Run ----
FROM node:20-alpine
WORKDIR /app
ENV NODE_ENV=production
ENV PORT=3000
ENV HOST=0.0.0.0
# La BD NO va en la imagen. Se usa en un volumen en /app/data
ENV DATABASE_URL=file:./data/tarkovpedia.db

# Solo copiamos artefactos necesarios
COPY --from=build /app/.output ./.output
COPY --from=build /app/public ./public

# Declaramos el punto de datos (volumen externo)
VOLUME ["/app/data"]

EXPOSE 3000
CMD ["node", ".output/server/index.mjs"]
